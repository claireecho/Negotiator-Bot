<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Negotiator Bot Test</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>üß™ Negotiator Bot Test</h1>
        <p>Test how well an AI negotiator can handle job offer negotiations!</p>
      </header>

      <div class="main-content">
        <div class="chat-container">
          <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">
              <div class="message-content">
                <strong>System:</strong> Welcome to the Negotiator Bot Test!
                This tool tests how well an AI negotiator can handle job offer
                negotiations. Click "Start Test" to watch the AI negotiator bot
                negotiate with a recruiter bot.
              </div>
            </div>
          </div>

          <!-- Typing indicators -->
          <div
            class="typing-indicators"
            id="typingIndicators"
            style="display: none"
          >
            <div
              class="typing-indicator"
              id="recruiterTyping"
              style="display: none"
            >
              <div class="typing-avatar">ü§ñ</div>
              <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
              <div class="typing-text">Recruiter Bot is typing...</div>
            </div>
            <div
              class="typing-indicator"
              id="negotiatorTyping"
              style="display: none"
            >
              <div class="typing-avatar">ü§ñ</div>
              <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
              <div class="typing-text">Negotiator Bot is typing...</div>
            </div>
          </div>
        </div>

        <!-- Offer Results Section -->
        <div class="offer-results" id="offerResults" style="display: none">
          <div class="results-header">
            <h3>üìä Negotiation Results</h3>
            <p>Final offer details after negotiation</p>
          </div>
          <div class="results-content">
            <div class="offer-card">
              <div class="offer-header">
                <div class="company-info">
                  <div class="company-logo">üè¢</div>
                  <div class="company-details">
                    <h4 id="finalCompanyName">Tech Company</h4>
                    <p id="finalPosition">Software Engineer II</p>
                  </div>
                </div>
              </div>
              <div class="offer-details">
                <div class="detail-row">
                  <span class="label">Initial Salary:</span>
                  <span class="value initial-salary" id="initialSalary"
                    >$85,000</span
                  >
                </div>
                <div class="detail-row">
                  <span class="label">Final Salary:</span>
                  <span class="value final-salary" id="finalSalary"
                    >$85,000</span
                  >
                </div>
                <div class="detail-row">
                  <span class="label">Salary Change:</span>
                  <span class="value change-amount" id="salaryChange">$0</span>
                </div>
                <div class="detail-row">
                  <span class="label">Negotiation Rounds:</span>
                  <span class="value" id="negotiationRounds">10</span>
                </div>
                <div class="detail-row">
                  <span class="label">Result:</span>
                  <span class="value result-status" id="resultStatus"
                    >No Change</span
                  >
                </div>
              </div>
            </div>
            <div class="test-summary">
              <h4>Test Summary</h4>
              <p id="testSummary">
                The negotiator bot attempted to improve the offer through
                professional negotiation tactics.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="api-key-container" id="apiKeyContainer">
        <div class="api-key-group">
          <input
            type="password"
            id="apiKeyInput"
            placeholder="Enter your OpenAI API key..."
            autocomplete="off"
          />
          <button id="saveApiKeyButton">Save API Key</button>
        </div>
        <div class="api-key-info">
          <small
            >Your API key is stored locally and never sent to our servers</small
          >
        </div>
      </div>

      <div class="input-container" id="inputContainer" style="display: none">
        <div class="button-group">
          <button
            id="botBattleBtn"
            class="battle-btn"
            title="Test Negotiator Bot"
          >
            <span class="icon">üß™</span>
            <span class="text">Start Test</span>
          </button>
          <button
            id="changeApiKeyButton"
            class="change-key-btn"
            title="Change API Key"
          >
            <span class="icon">üîÑ</span>
            <span class="text">Change</span>
          </button>
        </div>
      </div>

      <div class="status-bar">
        <div class="status-item">
          <span class="status-label">Status:</span>
          <span id="statusText">Ready to start</span>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let userApiKey = null;
      let botBattleActive = false;
      let battleRound = 0;
      let negotiatorContextId = null;
      let initialSalary = 85000;
      let finalSalary = 85000;

      // DOM elements
      const chatMessages = document.getElementById("chatMessages");
      const apiKeyInput = document.getElementById("apiKeyInput");
      const saveApiKeyButton = document.getElementById("saveApiKeyButton");
      const apiKeyContainer = document.getElementById("apiKeyContainer");
      const inputContainer = document.getElementById("inputContainer");
      const changeApiKeyButton = document.getElementById("changeApiKeyButton");
      const botBattleBtn = document.getElementById("botBattleBtn");
      const recruiterTyping = document.getElementById("recruiterTyping");
      const negotiatorTyping = document.getElementById("negotiatorTyping");
      const typingIndicators = document.getElementById("typingIndicators");
      const statusText = document.getElementById("statusText");
      const offerResults = document.getElementById("offerResults");

      function addMessage(content, isBot = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${
          isBot ? "bot-message" : "user-message"
        }`;

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";
        contentDiv.innerHTML = content;

        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function updateStatus(status, detail) {
        statusText.textContent = status;
      }

      function saveApiKey() {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
          alert("Please enter your OpenAI API key");
          return;
        }
        if (!apiKey.startsWith("sk-") || apiKey.length < 20) {
          alert("Please enter a valid OpenAI API key (starts with 'sk-')");
          return;
        }
        userApiKey = apiKey;
        localStorage.setItem("openai_api_key", apiKey);
        apiKeyContainer.style.display = "none";
        inputContainer.style.display = "block";
        addMessage(
          "API key saved successfully! You can now start the negotiator test.",
          true
        );
        updateStatus("API key configured", "Ready to test");
      }

      function loadApiKey() {
        const savedApiKey = localStorage.getItem("openai_api_key");
        if (savedApiKey) {
          userApiKey = savedApiKey;
          apiKeyContainer.style.display = "none";
          inputContainer.style.display = "block";
          addMessage(
            "API key loaded from storage. Ready to start the negotiator test!",
            true
          );
          updateStatus("API key loaded", "Ready to test");
        } else {
          addMessage(
            "Please enter your OpenAI API key to start the negotiator test.",
            true
          );
          updateStatus("API key required", "Not configured");
        }
      }

      function changeApiKey() {
        userApiKey = null;
        localStorage.removeItem("openai_api_key");
        botBattleActive = false;
        negotiatorContextId = null;
        inputContainer.style.display = "none";
        apiKeyContainer.style.display = "block";
        offerResults.style.display = "none";
        apiKeyInput.value = "";
        const messages = chatMessages.querySelectorAll(".message");
        for (let i = 1; i < messages.length; i++) {
          messages[i].remove();
        }
        addMessage("Please enter your new OpenAI API key to continue.", true);
        updateStatus("API key required", "Not configured");
      }

      function addBotMessage(botName, content) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message bot-message";

        const name =
          botName === "Recruiter Bot" ? "Recruiter Bot" : "Negotiator Bot";

        messageDiv.innerHTML = `
          <div class="message-content">
            <strong>${name}:</strong> ${content}
          </div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function showTypingIndicator(botName) {
        if (botName === "Recruiter Bot") {
          recruiterTyping.style.display = "flex";
        } else {
          negotiatorTyping.style.display = "flex";
        }
      }

      function hideTypingIndicator(botName) {
        if (botName === "Recruiter Bot") {
          recruiterTyping.style.display = "none";
        } else {
          negotiatorTyping.style.display = "none";
        }
      }

      function showOfferResults() {
        const salaryChange = finalSalary - initialSalary;
        const changeAmount =
          salaryChange > 0
            ? `+$${salaryChange.toLocaleString()}`
            : `$${salaryChange.toLocaleString()}`;
        const resultStatus =
          salaryChange > 0
            ? "Improved"
            : salaryChange < 0
            ? "Decreased"
            : "No Change";

        document.getElementById(
          "initialSalary"
        ).textContent = `$${initialSalary.toLocaleString()}`;
        document.getElementById(
          "finalSalary"
        ).textContent = `$${finalSalary.toLocaleString()}`;
        document.getElementById("salaryChange").textContent = changeAmount;
        document.getElementById("negotiationRounds").textContent = battleRound;
        document.getElementById("resultStatus").textContent = resultStatus;

        let summary =
          "The negotiator bot attempted to improve the offer through professional negotiation tactics.";
        if (salaryChange > 0) {
          summary = `The negotiator bot successfully improved the offer by $${salaryChange.toLocaleString()} through effective negotiation tactics.`;
        } else if (salaryChange < 0) {
          summary = `The negotiator bot's negotiation resulted in a decrease of $${Math.abs(
            salaryChange
          ).toLocaleString()} in the offer.`;
        } else {
          summary =
            "The negotiator bot maintained the original offer through negotiation, with no salary change achieved.";
        }

        document.getElementById("testSummary").textContent = summary;
        offerResults.style.display = "block";
      }

      function startBotBattle() {
        if (!userApiKey) {
          alert("Please enter your API key first");
          return;
        }

        botBattleActive = true;
        battleRound = 0;
        initialSalary = 85000;
        finalSalary = 85000;
        typingIndicators.style.display = "block";
        offerResults.style.display = "none";

        // Clear previous messages
        chatMessages.innerHTML = "";

        // Setup negotiator context if not already done
        setupNegotiatorForBattle();
      }

      async function setupNegotiatorForBattle() {
        if (!negotiatorContextId) {
          const userProfile = {
            years_experience: 5,
            industry: "technology",
            primary_skill: "software development",
            key_achievement: "led team that increased productivity by 40%",
            education_level: "Bachelors",
            leadership_experience: true,
            certifications: [],
          };

          try {
            const response = await fetch("/create_negotiation_context", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                api_key: userApiKey,
                company_name: "Tech Company",
                position: "Software Engineer II",
                user_profile: userProfile,
                target_salary: 120000,
                target_benefits: ["health_insurance", "401k", "stock_options"],
                deal_breakers: ["no_remote_work", "salary_below_100k"],
              }),
            });

            const data = await response.json();
            if (data.context_id) {
              negotiatorContextId = data.context_id;
            }
          } catch (error) {
            console.error("Error setting up negotiator:", error);
          }
        }

        // Start the battle
        await runBotBattle();
      }

      async function runBotBattle() {
        if (!botBattleActive) return;

        battleRound++;

        if (battleRound === 1) {
          // Recruiter starts with initial offer
          showTypingIndicator("Recruiter Bot");
          await new Promise((resolve) => setTimeout(resolve, 2000));
          hideTypingIndicator("Recruiter Bot");

          addBotMessage(
            "Recruiter Bot",
            "Thank you for your interest in joining our team! After reviewing your application, we're pleased to extend you an offer for the Software Engineer II position. The salary is $85,000 with comprehensive benefits including health insurance, 401k with 4% match, and 18 days PTO. This offer reflects our assessment of your qualifications and the market rate for this role. Do you have any questions about the offer?"
          );
        } else if (battleRound <= 10) {
          // Alternate between bots
          const isNegotiatorTurn = battleRound % 2 === 0;

          if (isNegotiatorTurn) {
            // Negotiator bot responds
            showTypingIndicator("Negotiator Bot");
            await new Promise((resolve) => setTimeout(resolve, 3000));
            hideTypingIndicator("Negotiator Bot");

            try {
              const response = await fetch("/generate_negotiation_response", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  context_id: negotiatorContextId,
                  message:
                    "We understand your concerns, but this is our standard rate for this level. We have many qualified candidates interested in this position.",
                  offer_details: {
                    salary: finalSalary,
                    benefits: ["health_insurance", "401k"],
                  },
                }),
              });

              const data = await response.json();
              if (data.response) {
                addBotMessage("Negotiator Bot", data.response);
              }
            } catch (error) {
              console.error("Error generating negotiator response:", error);
              addBotMessage(
                "Negotiator Bot",
                "I appreciate the offer, but I believe we can find a more mutually beneficial arrangement. My experience and skills warrant a more competitive compensation package."
              );
            }
          } else {
            // Recruiter bot responds
            showTypingIndicator("Recruiter Bot");
            await new Promise((resolve) => setTimeout(resolve, 2500));
            hideTypingIndicator("Recruiter Bot");

            const recruiterResponses = [
              "We understand your perspective. You make some good points. Let me see what I can do - I can bump this to $87,000.",
              "I appreciate your research and market knowledge. Let me talk to my manager about improving this offer.",
              "You're clearly talented and we don't want to lose you. I've spoken with compensation and we can go up to $90,000.",
              "I understand your concerns about market rates. Given your strong negotiation and the value you bring, we're willing to increase our offer.",
              "We're excited about your potential and don't want this opportunity to slip away. Let's talk about what it would take to get you to yes.",
              "Thank you for your patience. After reviewing your case and seeing your competing offers, we can offer $95,000 with the same benefits package.",
              "We appreciate your negotiation skills and transparency. We really want to make this work - what if we went to $100,000?",
              "I understand your position. Let me be frank - you're our top candidate and we're willing to be flexible. What's your target number?",
              "We value your expertise and the results you've delivered in the past. Let's find a number that works for both of us.",
              "You've been very persuasive. Let me present this final offer to leadership and get back to you with our best possible number.",
            ];

            const response =
              recruiterResponses[
                Math.min(battleRound - 2, recruiterResponses.length - 1)
              ];
            addBotMessage("Recruiter Bot", response);

            // Update final salary based on recruiter response
            if (battleRound === 2) {
              finalSalary = 87000; // Small bump after first negotiation
            } else if (battleRound === 4) {
              finalSalary = 90000; // Recruiter offers $90,000 earlier
            } else if (battleRound === 6) {
              finalSalary = 95000; // Further increase if negotiation continues
            } else if (battleRound === 8) {
              finalSalary = 100000; // Final best offer
            }
          }
        } else {
          // End battle
          botBattleActive = false;
          typingIndicators.style.display = "none";
          addBotMessage(
            "System",
            "Negotiation test completed! Both bots have reached their negotiation limits."
          );
          updateStatus("Test completed", "Ready for new test");
          showOfferResults();
          return;
        }

        // Continue battle after delay
        if (botBattleActive) {
          setTimeout(() => runBotBattle(), 1000);
        }
      }

      // Event Listeners
      saveApiKeyButton.addEventListener("click", saveApiKey);
      changeApiKeyButton.addEventListener("click", changeApiKey);
      botBattleBtn.addEventListener("click", startBotBattle);

      // Initialize the app
      document.addEventListener("DOMContentLoaded", () => {
        loadApiKey();
      });
    </script>
  </body>
</html>

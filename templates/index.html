<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recruiter Bot - Job Offer Negotiation</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>ðŸ¤– Recruiter Bot</h1>
        <p>Negotiate your way to a better job offer!</p>
      </header>

      <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
          <div class="message bot-message">
            <div class="message-content">
              <strong>Recruiter Bot:</strong> Welcome! I'm here to present you
              with a job opportunity. Click "Start Conversation" to begin!
            </div>
          </div>
        </div>

        <div class="offer-display" id="offerDisplay" style="display: none">
          <h3>Current Offer</h3>
          <div class="offer-card" id="offerCard">
            <!-- Offer details will be populated here -->
          </div>
        </div>

        <div class="api-key-container" id="apiKeyContainer">
          <div class="api-key-group">
            <input
              type="password"
              id="apiKeyInput"
              placeholder="Enter your OpenAI API key..."
              autocomplete="off"
            />
            <button id="saveApiKeyButton">Save API Key</button>
          </div>
          <div class="api-key-info">
            <small
              >Your API key is stored locally and never sent to our
              servers</small
            >
          </div>
        </div>

        <div class="input-container" id="inputContainer" style="display: none">
          <div class="input-group">
            <input
              type="text"
              id="messageInput"
              placeholder="Type your negotiation message..."
              disabled
            />
            <button id="sendButton" disabled>Send</button>
          </div>
          <div class="button-group">
            <button id="startButton" class="start-btn">
              Start Conversation
            </button>
            <button
              id="changeApiKeyButton"
              class="change-key-btn"
              title="Change API Key"
            >
              <span class="icon">ðŸ”„</span>
              <span class="text">Change</span>
            </button>
          </div>
        </div>
      </div>

      <div class="status-bar">
        <div class="status-item">
          <span class="status-label">Status:</span>
          <span id="statusText">Ready to start</span>
        </div>
        <div class="status-item">
          <span class="status-label">Conversation:</span>
          <span id="conversationStatus">Not started</span>
        </div>
      </div>
    </div>

    <script>
      let conversationStarted = false;
      let currentOfferLevel = null;
      let conversationHistory = [];
      let userApiKey = null;

      const chatMessages = document.getElementById("chatMessages");
      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendButton");
      const startButton = document.getElementById("startButton");
      const offerDisplay = document.getElementById("offerDisplay");
      const offerCard = document.getElementById("offerCard");
      const statusText = document.getElementById("statusText");
      const conversationStatus = document.getElementById("conversationStatus");
      const apiKeyInput = document.getElementById("apiKeyInput");
      const saveApiKeyButton = document.getElementById("saveApiKeyButton");
      const apiKeyContainer = document.getElementById("apiKeyContainer");
      const inputContainer = document.getElementById("inputContainer");
      const changeApiKeyButton = document.getElementById("changeApiKeyButton");

      function addMessage(content, isBot = false, isOffer = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${
          isBot ? "bot-message" : "user-message"
        }`;

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";

        if (isOffer) {
          contentDiv.innerHTML = content;
        } else {
          contentDiv.innerHTML = `<strong>${
            isBot ? "Recruiter Bot" : "You"
          }:</strong> ${content}`;
        }

        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function updateOfferDisplay(offer, level) {
        if (!offer) return;

        offerCard.innerHTML = `
                <div class="offer-title">${offer.title}</div>
                <div class="offer-salary">${offer.salary}</div>
                <div class="offer-benefits">
                    <strong>Benefits:</strong>
                    <ul>
                        ${offer.benefits
                          .map((benefit) => `<li>${benefit}</li>`)
                          .join("")}
                    </ul>
                </div>
                <div class="offer-description">${offer.description}</div>
            `;

        offerDisplay.style.display = "block";
        currentOfferLevel = level;
      }

      function updateStatus(status, conversation = null) {
        statusText.textContent = status;
        if (conversation) {
          conversationStatus.textContent = conversation;
        }
      }

      function saveApiKey() {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
          alert("Please enter your OpenAI API key");
          return;
        }

        // Basic validation for OpenAI API key format
        if (!apiKey.startsWith("sk-") || apiKey.length < 20) {
          alert("Please enter a valid OpenAI API key (starts with 'sk-')");
          return;
        }

        userApiKey = apiKey;
        localStorage.setItem("openai_api_key", apiKey);

        // Hide API key container and show input container
        apiKeyContainer.style.display = "none";
        inputContainer.style.display = "block";

        addMessage(
          "API key saved successfully! You can now start negotiating.",
          true
        );
        updateStatus("API key configured", "Ready to start");
      }

      function loadApiKey() {
        const savedApiKey = localStorage.getItem("openai_api_key");
        if (savedApiKey) {
          userApiKey = savedApiKey;
          apiKeyContainer.style.display = "none";
          inputContainer.style.display = "block";
          addMessage(
            "Welcome back! Your API key is loaded. Ready to negotiate!",
            true
          );
          updateStatus("API key loaded", "Ready to start");
        } else {
          addMessage(
            "Please enter your OpenAI API key to start negotiating with the recruiter bot.",
            true
          );
          updateStatus("API key required", "Not configured");
        }
      }

      function changeApiKey() {
        // Clear the current API key
        userApiKey = null;
        localStorage.removeItem("openai_api_key");

        // Reset conversation state
        conversationStarted = false;
        currentOfferLevel = null;
        conversationHistory = [];

        // Hide input container and show API key container
        inputContainer.style.display = "none";
        apiKeyContainer.style.display = "block";

        // Clear the API key input field
        apiKeyInput.value = "";

        // Reset UI elements
        messageInput.disabled = true;
        sendButton.disabled = true;
        startButton.style.display = "block";
        startButton.disabled = false;

        // Clear chat messages except the first one
        const messages = chatMessages.querySelectorAll(".message");
        for (let i = 1; i < messages.length; i++) {
          messages[i].remove();
        }

        // Hide offer display
        offerDisplay.style.display = "none";

        addMessage("Please enter your new OpenAI API key to continue.", true);
        updateStatus("API key required", "Not configured");
      }

      async function startConversation() {
        if (!userApiKey) {
          alert("Please enter your OpenAI API key first");
          return;
        }

        try {
          updateStatus("Starting conversation...", "Starting");
          startButton.disabled = true;

          const response = await fetch("/start_conversation", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              api_key: userApiKey,
            }),
          });

          const data = await response.json();

          if (data.error) {
            addMessage(data.error, true);
            updateStatus("Error occurred", "Failed");
            startButton.disabled = false;
            return;
          }

          addMessage(data.message, true);
          updateOfferDisplay(data.offer, data.offer_level);

          conversationStarted = true;
          messageInput.disabled = false;
          sendButton.disabled = false;
          startButton.style.display = "none";

          updateStatus("Conversation started", "Active");
        } catch (error) {
          console.error("Error starting conversation:", error);
          addMessage(
            "Sorry, there was an error starting the conversation. Please try again.",
            true
          );
          updateStatus("Error occurred", "Failed");
          startButton.disabled = false;
        }
      }

      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || !conversationStarted) return;

        addMessage(message, false);
        messageInput.value = "";
        sendButton.disabled = true;
        updateStatus("Processing your message...", "Active");

        try {
          const response = await fetch("/negotiate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              offer_level: currentOfferLevel,
              history: conversationHistory,
              api_key: userApiKey,
            }),
          });

          const data = await response.json();

          addMessage(data.response, true);
          conversationHistory.push({ user: message, bot: data.response });

          if (data.new_offer) {
            addMessage(
              `
                        <div class="offer-update">
                            <h4>ðŸŽ‰ Offer Improved!</h4>
                            <div class="offer-title">${
                              data.new_offer.title
                            }</div>
                            <div class="offer-salary">${
                              data.new_offer.salary
                            }</div>
                            <div class="offer-benefits">
                                <strong>Benefits:</strong>
                                <ul>
                                    ${data.new_offer.benefits
                                      .map((benefit) => `<li>${benefit}</li>`)
                                      .join("")}
                                </ul>
                            </div>
                        </div>
                    `,
              true,
              true
            );
            updateOfferDisplay(data.new_offer, data.new_offer_level);
          } else if (data.current_offer) {
            updateOfferDisplay(data.current_offer, data.offer_level);
          }

          if (data.offer_declined) {
            addMessage(
              "I'm sorry, but we cannot improve the offer further at this time. Thank you for your interest in our company.",
              true
            );
            updateStatus("Offer declined", "Ended");
            messageInput.disabled = true;
            sendButton.disabled = true;
          } else {
            updateStatus("Ready for your response", "Active");
          }
        } catch (error) {
          console.error("Error sending message:", error);
          addMessage(
            "Sorry, there was an error processing your message. Please try again.",
            true
          );
          updateStatus("Error occurred", "Active");
        }

        sendButton.disabled = false;
      }

      // Event listeners
      startButton.addEventListener("click", startConversation);
      sendButton.addEventListener("click", sendMessage);
      saveApiKeyButton.addEventListener("click", saveApiKey);
      changeApiKeyButton.addEventListener("click", changeApiKey);

      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !sendButton.disabled) {
          sendMessage();
        }
      });

      apiKeyInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          saveApiKey();
        }
      });

      // Enable/disable send button based on input
      messageInput.addEventListener("input", () => {
        sendButton.disabled =
          !messageInput.value.trim() || !conversationStarted;
      });

      // Initialize the app
      document.addEventListener("DOMContentLoaded", () => {
        loadApiKey();
      });
    </script>
  </body>
</html>
